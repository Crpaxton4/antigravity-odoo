version: '3.8'

services:
  # ============================================================================
  # POSTGRESQL - Consolidated database for Odoo, n8n, and Grafana
  # ============================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_ADMIN_PASSWORD=${POSTGRES_ADMIN_PASSWORD}
      - POSTGRES_ODOO_PASSWORD=${POSTGRES_ODOO_PASSWORD}
      - POSTGRES_N8N_PASSWORD=${POSTGRES_N8N_PASSWORD}
      - POSTGRES_GRAFANA_PASSWORD=${POSTGRES_GRAFANA_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    networks:
      - internal
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres}' ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # PGADMIN - Database administration interface
  # ============================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    hostname: pgadmin
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL:-admin@localhost.com}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD:-admin}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    volumes:
      - pgadmin-data:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro
      - ./pgadmin/pgpass:/tmp/pgpassfile:ro
    ports:
      - "5050:80"
    networks:
      - internal
      - public
    depends_on:
      postgres:
        condition: service_healthy

  # ============================================================================
  # ODOO - ERP System
  # ============================================================================
  odoo:
    image: odoo:19.0
    container_name: odoo
    hostname: odoo
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8069:8069"
      - "5678:5678" # For debugpy
    volumes:
      - odoo-web-data:/var/lib/odoo
      - ./config:/etc/odoo
      - ./addons:/mnt/extra-addons
    environment:
      - HOST=postgres
      - USER=odoo_user
      - PASSWORD=${POSTGRES_ODOO_PASSWORD}
      - DB_NAME=odoo_db
    command: --dev=reload,xml,qweb,werkzeug -c /etc/odoo/odoo.conf
    networks:
      - internal
      - public

  # ============================================================================
  # N8N - Workflow Automation
  # ============================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    hostname: n8n
    restart: unless-stopped
    ports:
      - "5679:5678"
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n_db
      - DB_POSTGRESDB_USER=n8n_user
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_N8N_PASSWORD}
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_USER_MANAGEMENT_JWT_SECRET=${N8N_USER_MANAGEMENT_JWT_SECRET}
      - OLLAMA_HOST=${OLLAMA_HOST:-ollama:11434}
    volumes:
      - n8n-data:/home/node/.n8n
      - ./shared:/data/shared
    networks:
      - internal
      - public
    depends_on:
      postgres:
        condition: service_healthy

  # ============================================================================
  # OLLAMA - Local LLM (CPU mode)
  # ============================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    hostname: ollama
    restart: unless-stopped
    ports:
      - "11435:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - internal
      - public

  # Initialize Ollama with llama3.2 model
  ollama-init:
    image: ollama/ollama:latest
    container_name: ollama-init
    volumes:
      - ollama-data:/root/.ollama
    entrypoint: /bin/sh
    environment:
      - OLLAMA_HOST=ollama:11434
    command:
      - "-c"
      - "sleep 5; ollama pull llama3.2"
    networks:
      - internal
    depends_on:
      - ollama

  # ============================================================================
  # MONITORING STACK
  # ============================================================================

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    hostname: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - internal
      - public

  # PostgreSQL Exporter - Database metrics
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    hostname: postgres-exporter
    restart: unless-stopped
    environment:
      - DATA_SOURCE_NAME=postgresql://postgres_admin:${POSTGRES_ADMIN_PASSWORD}@postgres:5432/postgres?sslmode=disable
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy

  # cAdvisor - Container metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    hostname: cadvisor
    restart: unless-stopped
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8080:8080"
    networks:
      - internal
      - public

  # Grafana - Visualization and dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    hostname: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=
      # Configure Grafana to use PostgreSQL
      - GF_DATABASE_TYPE=postgres
      - GF_DATABASE_HOST=postgres:5432
      - GF_DATABASE_NAME=grafana_db
      - GF_DATABASE_USER=grafana_user
      - GF_DATABASE_PASSWORD=${POSTGRES_GRAFANA_PASSWORD}
      - GF_DATABASE_SSL_MODE=disable
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    networks:
      - internal
      - public
    depends_on:
      - prometheus
      - postgres

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  internal:
    driver: bridge
  public:
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres-data:
  pgadmin-data:
  odoo-web-data:
  n8n-data:
  ollama-data:
  prometheus-data:
  grafana-data:
